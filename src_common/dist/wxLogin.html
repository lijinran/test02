<!DOCTYPE html><html lang="en"><head><title>微信登录</title><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><script src="//res.wx.qq.com/open/js/jweixin-1.2.0.js"></script><style>.field-tooltipWrap{position:absolute;left:0;top:0;width:100%;z-index:19891014}.field-tooltipInner{pointer-events:none;display:table;position:fixed;left:0;top:0;width:100%;height:100%}.field-tooltip{display:table-cell;vertical-align:middle;text-align:center}.field-tooltip .field-invalidmsg,.field-tooltip .field-validmsg{color:#fff}.field-tooltip .zvalid-resultformat{display:inline-block;position:relative;background-color:rgba(0,0,0,.8);color:#fff;padding:10px 15px;font-size:14px;border-radius:6px;box-shadow:0 0 8px rgba(0,0,0,.1);pointer-events:auto;animation-name:fieldTipBounceIn;-webkit-animation-name:fieldTipBounceIn;-webkit-animation-fill-mode:both;animation-fill-mode:both;-webkit-animation-duration:.18s;animation-duration:.18s}@-webkit-keyframes fieldTipBounceIn{0%{opacity:0;-webkit-transform:scale3d(.3,.3,.3);transform:scale3d(.3,.3,.3)}100%{opacity:1;-webkit-transform:scale3d(1,1,1);transform:scale3d(1,1,1)}}.loading{margin:auto;position:absolute;top:0;left:0;bottom:0;right:0;width:152px;height:62px;text-align:center;font-size:.9rem}</style></head><body><div class="loading"><img src="loading.gif" alt=""><br>正在获取定位...</div><div id="message"></div><script src="config.js?v=2017"></script><script>function createXHR(){if(window.XMLHttpRequest)return new XMLHttpRequest;if(!window.ActiveXObject)throw new Error("浏览器不支持XHR对象！");for(var e=0,t=["MSXML2.XMLHttp","Microsoft.XMLHTTP"].length;e<t;e++)try{return new ActiveXObject(version[e])}catch(e){}}function pajax(e){var t=createXHR();function o(){200==t.status?e.success(JSON.parse(t.responseText)):e.fail(JSON.parse(t.responseText))}e.url=e.url+"?rand="+Math.random(),e.data=params(e.data),"get"===e.method&&(e.url+=-1==e.url.indexOf("?")?"?"+e.data:"&"+e.data),!0===e.async&&(t.onreadystatechange=function(){4==t.readyState&&o()}),t.open(e.method,e.url,e.async),"post"===e.method?(t.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),t.send(e.data)):t.send(null),!1===e.async&&o()}function params(e){var t=[];for(var o in e)t.push(encodeURIComponent(o)+"="+encodeURIComponent(e[o]));return t.join("&")}function getQueryString(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),o=window.location.search.substr(1).match(t);return null!=o?o[2]:""}function getMessage(e){var t=document.getElementById("message"),o='<div class="field-tooltipWrap"><div class="field-tooltipInner"><div class="field-tooltip fieldTipBounceIn"><div class="zvalid-resultformat">'+e+"</div></div></div></div>";t.innerHTML=o,setTimeout(function(){t.innerHTML=""},1500)}document.addEventListener("WeixinJSBridgeReady",function(){WeixinJSBridge.call("hideOptionMenu")});var WXINFO,host=config.HOST,wxuserInfo="/cloud2.member.api/wx/userInfoSC.do",wxLogin="/cloud2.member.api/member/userInfo/wxLogin.do",getSignatureUrl="/cloud2.member.api/wx/jsSignature.do",codeScan="/cloud2.barcode.api/order/info/cqQueryOrderInfo.do",getInfo="/cloud2.member.api/member/userInfo/getCurLoginUser.do",scCheck="/cloud2.barcode.api/barcode/orderCheck/cqCheck.do",loddproject=window.localStorage.getItem("project")||"_jtz201804_",wxcode=getQueryString("code"),latitude="",longitude="",userToken=window.localStorage.getItem(loddproject+"wxLogin");userToken&&(userToken=JSON.parse(userToken)),userToken=userToken&&userToken.userToken,barData=window.sessionStorage.getItem("barcode"),barData||getMessage("请重新扫码");var from=getQueryString("from");function getSign(){pajax({url:host+getSignatureUrl,method:"get",data:{url:window.location.href},success:function(e){var t=e.data;200==e.code&&(wx.config({debug:!1,appId:config.wappId,timestamp:t.timestamp,nonceStr:t.nonceStr,signature:t.signature,jsApiList:["getLocation"]}),wx.ready(function(){wx.getLocation({type:"wgs84",complete:function(e){latitude=e.latitude,longitude=e.longitude,latitude&&longitude&&(latitude=nEncrypt(e.latitude+""),longitude=nEncrypt(e.longitude+"")),from?barcodeScan():wxinfo()},fail:function(){from?barcodeScan():wxinfo()},cancel:function(e){from?barcodeScan():wxinfo()}})}))},fail:function(e){getMessage("网络错误")},async:!0})}function getUserInfo(t,o,n){pajax({url:host+getInfo,async:!0,method:"post",data:{userToken:userToken},success:function(e){200==e.code?o.barcode==config.publicCode&&"jtz_noactivity"==n?window.location.href="./noactivity.html":o.barcode==config.publicCode?checkBarcode(t,o):window.location.href=n+"/loading.html":601==e.code&&wxDologin(t,o)}})}function barcodeScan(){pajax({url:host+codeScan,method:"post",data:{barcode:barData,lng:longitude||"",lat:latitude||"",userToken:userToken},success:function(e){if(isObject(e)&&200==e.code&&e.data&&"object"==typeof e.data){var t=e.data.status;if(2!=e.data.style)return!(window.location.href="http://qr.cncqti.com/formal/jtzupdate.html");if(3102!=t&&1001!=t)return void jumpAppTip(e.data.status,e.data.resource||"xlongyun");if(window.sessionStorage&&(0==e.data.isLogin&&window.localStorage.removeItem(e.data.resource+"wxLogin"),WXINFO=window.localStorage.getItem(loddproject+"wxInfo"),loddproject=e.data.resource,window.localStorage.setItem("project",e.data.resource),window.localStorage.setItem(e.data.resource+"wxInfo",WXINFO),window.sessionStorage.setItem(e.data.resource+"barcodeData",JSON.stringify(e.data))),e.data.resource&&""!==e.data.resource){if(from)return getUserInfo(JSON.parse(WXINFO),e.data,e.data.resource),!1;wxDologin(JSON.parse(WXINFO),e.data)}else getMessage("未找到应用对应的模板")}else if(isObject(e)&&1001==e.code&&e.data)e.data.resource?getMessage("码状态已激活"):getMessage("码状态未激活");else{if(isObject(e)&&(3101==e.code||3103==e.code||3104==e.code))return!(window.location.href="http://qt.cncqti.com/formal/update.html");getMessage(e.msg)}},fail:function(e){getMessage("网络错误")},async:!0})}function checkBarcode(t,o){pajax({url:host+scCheck,async:!0,method:"post",data:{barcode:o.barcode,pwd:config.pwd,appId:o.appId,id:o.id,province:o.province,city:o.city,area:o.area,userToken:userToken,relationId:o.product_id,comId:o.comId,ip:o.ip},success:function(e){200==e.code?(window.localStorage.setItem(o.resource+"giftId",e.data.cq_gift_id),window.location.href=o.resource+"/ucenter.html"):601==e.code&&wxDologin(t,o)}})}function isObject(e){return"[object Object]"==toString.call(e)}function wxinfo(){pajax({url:host+wxuserInfo,method:"get",data:{code:wxcode},success:function(e){200==e.code?(window.localStorage.setItem(loddproject+"wxInfo",JSON.stringify(e.data)),barcodeScan()):e.msg&&getMessage(e.msg)},fail:function(e){getMessage("网络错误")},async:!0})}function wxDologin(t,o){pajax({url:host+wxLogin,method:"post",data:{openId:t.openid,comId:o.comId,nickname:t.nickname,sex:t.sex,accessToken:t.access_token,refreshToken:t.refresh_token,headImgUrl:t.headimgurl,province:t.province,city:t.city,unionId:t.unionid,materialsId:o.product_id,provinceUser:o.province,cityUser:o.city,barcode:o.barcode},success:function(e){if(200==e.code)return window.localStorage.setItem(loddproject+"wxLogin",JSON.stringify(e.data)),o.barcode==config.publicCode&&"jtz_noactivity"==o.resource?window.location.href="./noactivity.html":o.barcode==config.publicCode?checkBarcode(t,o):window.location.href=o.resource+"/loading.html",!1;e.msg&&getMessage(e.msg)},fail:function(e){getMessage("网络错误")},async:!0})}function jumpAppTip(e,t){return window.location.href=t+"/application.html?status="+e,!1}wxcode||from?getSign():getMessage("微信授权参数不正确");var char="diogoxiang20170413",pre="0x";function getRandom(e){var t,o="";t=char.split("");for(var n=0;n<e;n++){var a=Math.ceil(Math.random()*(char.length-1));o+=pre+t[a]}return o}function nEncode16(e){if(null==(e=e.toLowerCase()).match(/^[-+]?\d*$/)){for(var t=e.split(""),o="",n=0;n<t.length;n++)t[n]=t[n].charCodeAt(),t[n]=t[n].toString(16),o=o+pre+t[n];return o+"{1"}return(e=parseInt(e).toString(16))+"{0"}function nEncrypt(e){var t="";t+=getRandom(2);var o=nEncode16(e).split("{"),n=o[0].length;if(1==(n=n.toString(16)).length)n="0"+n;else if(2<n.length)return"";(t+=n,"0"==o[1]?t+=0:"1"==o[1]&&(t+=1),(t+=o[0]).length<20)&&(t+=getRandom(20-t.length));return t}</script></body></html>